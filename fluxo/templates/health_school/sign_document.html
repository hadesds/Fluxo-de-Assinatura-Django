{% extends 'base.html' %}

{% block title %}Assinar Documento - {{ health_school.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-12">
            <div class="card shadow-lg">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">
                        <i class="fas fa-pen-fancy"></i>
                        Assinatura Digital de Documento
                    </h3>
                </div>
                <div class="card-body">
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-crosshairs"></i>
                                Clique na Posição Desejada para Assinar
                            </h6>
                        </div>
                        <div class="card-body p-0 text-center">
                            <div id="pdf-container" style="overflow: auto; max-height: 70vh;">
                                <canvas id="pdf-viewer"></canvas>
                            </div>
                            
                            <div class="p-3 bg-light border-top">
                                <p class="mb-0 small text-muted">
                                    Posição da assinatura digital:
                                    <span id="selected-coords" class="fw-bold text-danger">
                                        (Coordenadas: Não Selecionado)
                                    </span>
                                    — Clique no PDF acima para selecionar.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form method="post" id="signatureForm">
                        {% csrf_token %}
                        
                        <input type="hidden" name="signature_x" id="signature_x" value="">
                        <input type="hidden" name="signature_y" id="signature_y" value="">

                        <div class="card border-warning mb-4">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i class="fas fa-id-card"></i>
                                    Dados para Assinatura
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="signer_cpf" class="form-label">
                                        <i class="fas fa-fingerprint"></i> Seu CPF *
                                    </label>
                                    <input type="text" 
                                           class="form-control form-control-lg" 
                                           id="signer_cpf" 
                                           name="signer_cpf" 
                                           placeholder="000.000.000-00"
                                           maxlength="14"
                                           required>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="accept_terms" name="accept_terms" required>
                                    <label class="form-check-label" for="accept_terms">
                                        <strong>Li e concordo com os termos deste documento</strong>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a href="{% url 'health_school_dashboard' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" 
                                    class="btn btn-warning btn-lg" 
                                    id="signButton"
                                    disabled>
                                <i class="fas fa-signature"></i> Assinar Documento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
// Define o worker source do PDF.js (necessário para que funcione)
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const pdfContainer = document.getElementById('pdf-container');
const canvas = document.getElementById('pdf-viewer');
const context = canvas.getContext('2d');
const signButton = document.getElementById('signButton');
const signatureXField = document.getElementById('signature_x');
const signatureYField = document.getElementById('signature_y');
const coordsDisplay = document.getElementById('selected-coords');

let pdfDocument = null; // Armazenará o objeto PDF.js

// Função para buscar e renderizar a primeira página do PDF
async function renderPdf() {
    const pdfUrl = "{% url 'download_original_document' document.id %}";

    try {
        // 1. Fetch the PDF file
        const loadingTask = pdfjsLib.getDocument(pdfUrl);
        pdfDocument = await loadingTask.promise;

        // 2. Load the first page
        const page = await pdfDocument.getPage(1);
        
        // 3. Define scale and viewport
        const scale = 1.5;
        const viewport = page.getViewport({ scale: scale });

        // Defina o tamanho do canvas para o tamanho do viewport
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        // 4. Render the PDF page into the canvas context
        const renderContext = {
            canvasContext: context,
            viewport: viewport
        };
        await page.render(renderContext).promise;

        // 5. Adiciona o evento de clique para seleção de posição
        canvas.addEventListener('click', captureCoordinates);
        canvas.style.cursor = 'crosshair';

    } catch (error) {
        console.error("Erro ao carregar ou renderizar o PDF:", error);
        canvas.style.display = 'none'; // Esconde o canvas se falhar
        pdfContainer.innerHTML = '<div class="alert alert-danger m-3">Não foi possível carregar o PDF. Certifique-se de que o documento exista e as configurações de mídia e permissões estejam corretas.</div>';
    }
}

// Função para capturar as coordenadas no Canvas
function captureCoordinates(event) {
    const rect = canvas.getBoundingClientRect();
    
    // Coordenadas relativas ao canvas (e, portanto, ao PDF renderizado)
    const x = event.clientX - rect.left; 
    const y = event.clientY - rect.top;
    
    // NOTA: Estas coordenadas (X, Y) são em pixels do Canvas. 
    // Você deve enviá-las para o Backend, que as converterá em unidades de PDF 
    // (usualmente 'points' ou 'pt', onde 1pt = 1/72 de polegada) na função apply_signature_to_pdf.

    signatureXField.value = x.toFixed(0);
    signatureYField.value = canvas.height - y.toFixed(0); // Inverte Y, pois a origem do PDF é inferior esquerda, não superior esquerda.
    
    coordsDisplay.classList.remove('text-danger');
    coordsDisplay.classList.add('text-success');
    coordsDisplay.innerHTML = `(Selecionado X: ${x.toFixed(0)}, Y: ${signatureYField.value})`;
    signButton.disabled = false;
    
    // Opcional: Desenhar um ponto onde o usuário clicou para feedback visual
    context.fillStyle = 'red';
    context.beginPath();
    context.arc(x, y, 5, 0, 2 * Math.PI);
    context.fill();
}


// --- RESTANTE DO JAVASCRIPT (MÁSCARA E VALIDAÇÃO) ---

// Máscara de CPF (MANTIDA)
document.getElementById('signer_cpf').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    
    if (value.length > 9) {
        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
    } else if (value.length > 6) {
        value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
    } else if (value.length > 3) {
        value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
    }
    
    e.target.value = value;
});

// Confirmação ao assinar (AJUSTADA para verificar coordenadas)
document.getElementById('signatureForm').addEventListener('submit', function(e) {
    const cpf = document.getElementById('signer_cpf').value;
    const accepted = document.getElementById('accept_terms').checked;
    const x = signatureXField.value;

    if (!x) {
        e.preventDefault();
        alert('Por favor, clique no visor do documento para selecionar a área de assinatura.');
        return false;
    }
    
    if (!accepted || cpf.length < 14) {
        e.preventDefault();
        alert('Por favor, preencha o CPF e aceite os termos.');
        return false;
    }
    
    const confirmed = confirm(
        'Confirma a assinatura digital deste documento na posição selecionada?\n\n' +
        'Esta ação não pode ser desfeita e terá validade jurídica.'
    );
    
    if (confirmed) {
        document.getElementById('signButton').innerHTML = 
            '<i class="fas fa-spinner fa-spin"></i> Processando Assinatura...';
        document.getElementById('signButton').disabled = true;
        return true;
    } else {
        e.preventDefault();
        return false;
    }
});

// Inicia o carregamento do PDF quando a página estiver pronta
window.onload = renderPdf;
</script>
{% endblock %}